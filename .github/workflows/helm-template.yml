name: Helm Chart Lint and Template

on:
  workflow_call:
    inputs:
      charts_directory:
        description: 'The directory to search for Helm charts'
        required: false
        default: '.'
        type: string

jobs:
  template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Find Custom Helm Charts
        id: find_charts
        run: |
          found_charts=$(find ${{ inputs.charts_directory }} -name "Chart.yaml" -not -path "*/charts/*" -print0 | xargs -0 -n1 dirname)
          custom_charts=""
          for chart in $found_charts; do
            if [ -d "$chart/templates" ] && [ "$(ls -A $chart/templates)" ]; then
              custom_charts="$custom_charts $chart"
            fi
          done
          final_list=$(echo "$custom_charts" | xargs | tr '\n' ' ')
          echo "charts=$final_list" >> "$GITHUB_OUTPUT"

      - name: Run Helm Dependency Build
        run: |
          for chart_path in ${{ steps.find_charts.outputs.charts }}; do
            helm dependency build "$chart_path"
          done

      - name: Run Helm Template
        run: |
          failed_templates=()
          error_log_dir="/tmp/helm_errors"
          mkdir -p "$error_log_dir"
          error_count=0

          for chart_path in ${{ steps.find_charts.outputs.charts }}; do
            release_name=$(basename "$chart_path")

            extra_values=$(find "$chart_path" -maxdepth 1 -name "*.yaml" ! -name "Chart.yaml")

            for value_file in $extra_values; do
              if ! helm template "$release_name" "$chart_path" -f "$value_file" --dry-run > /dev/null 2> "$error_log_dir/error_$error_count.log"; then
                echo "::error::Failed to template $chart_path with $value_file"
                cat "$error_log_dir/error_$error_count.log"
                failed_templates+=("$chart_path|$value_file|$error_count")
                ((error_count++))
              else
                echo "âœ“ Successfully templated $chart_path with $value_file"
              fi
            done
          done

          if [ ${#failed_templates[@]} -gt 0 ]; then
            echo ""
            echo "::error::=========================================="
            echo "::error::Failed to template ${#failed_templates[@]} chart(s):"
            echo "::error::=========================================="
            for failed in "${failed_templates[@]}"; do
              IFS='|' read -r chart_path value_file err_idx <<< "$failed"
              echo "::error::"
              echo "::error::Chart: $chart_path"
              echo "::error::Values: $value_file"
              echo "::error::Error:"
              while IFS= read -r line; do
                echo "::error::  $line"
              done < "$error_log_dir/error_$err_idx.log"
              echo "::error::----------------------------------------"
            done
            echo "::error::=========================================="
            exit 1
          fi

          echo ""
          echo "All templates validated successfully!"
